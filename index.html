<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>eSIM Store</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
    :root {
        --bg: #fdfdfd;
        --card-bg: #ffffff;
        --primary: #000000;
        --secondary: #6e6e73;
        --accent: #f5f5f7;
        --border: #e5e5e5;
    }

    body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background: var(--bg);
        color: #1d1d1f;
    }

    .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    /* Search Header */
    .hero-section { text-align: center; margin-bottom: 40px; }
    h1 { font-size: 40px; font-weight: 700; margin-bottom: 24px; }

    .search-wrapper {
        position: relative;
        max-width: 500px;
        margin: 0 auto;
    }

    #search {
        width: 100%;
        padding: 16px 20px;
        border-radius: 30px;
        border: 1px solid var(--border);
        font-size: 16px;
        background: white;
        transition: all 0.2s;
        box-sizing: border-box;
    }

    #search:focus {
        outline: none;
        border-color: #0071e3;
        box-shadow: 0 0 0 4px rgba(0,113,227,0.1);
    }

    /* Country Results */
    .country-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 16px;
        margin-top: 20px;
    }

    .country-card {
        background: white;
        padding: 20px;
        border-radius: 16px;
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 15px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .country-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.05);
    }

    .country-card img {
        width: 40px;
        height: 30px;
        object-fit: cover;
        border-radius: 4px;
    }

    /* Detail View Styles */
    .breadcrumb {
        font-size: 14px;
        color: var(--secondary);
        margin-bottom: 10px;
    }

    .detail-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
    }

    .package-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
        gap: 20px;
    }

    .pkg-card {
        background: white;
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 24px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition: border-color 0.2s;
    }

    .pkg-card:hover { border-color: #000; }

    .pkg-data { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
    .pkg-duration { color: var(--secondary); font-size: 14px; margin-bottom: 20px; }
    
    .price-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-top: auto;
    }

    .pkg-price { font-size: 20px; font-weight: 600; }

    .go-btn {
        background: #f5f5f7;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.2s;
    }

    .pkg-card:hover .go-btn {
        background: #000;
        color: #fff;
    }

    .hidden { display: none; }
    .back-link { cursor: pointer; color: #0071e3; text-decoration: none; }
</style>
</head>
<body>

<div class="container">
    <div id="main-view">
        <div class="hero-section">
            <h1>Where to next?</h1>
            <div class="search-wrapper">
                <input type="text" id="search" placeholder="Search destinations...">
            </div>
        </div>
        <div id="country-list" class="country-grid"></div>
    </div>

    <div id="detail-view" class="hidden">
        <nav class="breadcrumb">
            <span class="back-link" onclick="showMainView()">Store</span> / <span id="bread-country">Country</span>
        </nav>
        
        <div class="detail-header" id="detail-header-content">
            </div>

        <div id="package-list" class="package-grid"></div>
    </div>

    <div id="status" style="text-align:center; margin-top:40px; color:#888;">Fetching latest plans...</div>
</div>

<script>
const API_BASE = "https://backend.tayre0089.workers.dev";
let allPlans = [];

/* --- Load Data --- */
async function loadPlans() {
    try {
        const res = await fetch(API_BASE + "/products");
        allPlans = await res.json();
        document.getElementById("status").style.display = "none";
        renderCountries();
    } catch (e) {
        document.getElementById("status").textContent = "Connection error.";
    }
}

/* --- Render List --- */
function renderCountries() {
    const q = document.getElementById("search").value.toLowerCase();
    const list = document.getElementById("country-list");
    list.innerHTML = "";
    
    const unique = [...new Set(allPlans.map(p => p.country))].sort();
    const filtered = unique.filter(c => c.toLowerCase().includes(q));

    filtered.forEach(name => {
        const pkg = allPlans.find(p => p.country === name);
        const card = document.createElement("div");
        card.className = "country-card";
        card.innerHTML = `
            <img src="${pkg.imageUrl || ''}">
            <span style="font-weight:500">${name}</span>
        `;
        card.onclick = () => showDetail(name);
        list.appendChild(card);
    });
}

/* --- Show Packages --- */
function showDetail(countryName) {
    document.getElementById("main-view").classList.add("hidden");
    document.getElementById("detail-view").classList.remove("hidden");
    document.getElementById("bread-country").textContent = countryName;
    window.scrollTo(0,0);

    const pkgs = allPlans.filter(p => p.country === countryName);
    const header = document.getElementById("detail-header-content");
    header.innerHTML = `
        <img src="${pkgs[0].imageUrl}" style="width:50px; border-radius:8px;">
        <h2 style="font-size:32px; margin:0">eSIM for ${countryName}</h2>
    `;

    const pkgList = document.getElementById("package-list");
    pkgList.innerHTML = "";

    // Sort by price
    pkgs.sort((a,b) => a.priceUSD - b.priceUSD).forEach(pkg => {
        const card = document.createElement("div");
        card.className = "pkg-card";
        card.innerHTML = `
            <div>
                <div class="pkg-data">${pkg.dataAmount}</div>
                <div class="pkg-duration">${pkg.validityDays} days</div>
            </div>
            <div class="price-row">
                <div class="pkg-price">$${pkg.priceUSD.toFixed(2)}</div>
                <button class="go-btn" onclick="buyEsim('${pkg.id}', this)">→</button>
            </div>
        `;
        pkgList.appendChild(card);
    });
}

function showMainView() {
    document.getElementById("detail-view").classList.add("hidden");
    document.getElementById("main-view").classList.remove("hidden");
}

/* --- Checkout --- */
async function buyEsim(packageId, btn) {
    btn.textContent = "...";
    try {
        const res = await fetch(API_BASE + "/create-checkout", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ packageId })
        });
        const data = await res.json();
        if (data.url) window.location.href = data.url;
    } catch (err) {
        alert("Payment system unavailable.");
        btn.textContent = "→";
    }
}

document.getElementById("search").addEventListener("input", renderCountries);
loadPlans();
</script>

</body>
</html>
